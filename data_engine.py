import pandas as pd
import numpy as np
from prophet import Prophet
import joblib
import os
from datetime import datetime

# ==========================================
# 1. 全国热门城市与景点数据库 (20城 x 10景)
# ==========================================
CHINA_TOUR_DB = {
    "北京": ["故宫", "环球影城", "天坛", "颐和园", "八达岭长城", "南锣鼓巷", "国家博物馆", "恭王府", "什刹海",
             "奥林匹克公园"],
    "上海": ["外滩", "迪士尼乐园", "东方明珠", "豫园", "武康大楼", "南京路步行街", "陆家嘴", "静安寺", "新天地",
             "上海博物馆"],
    "广州": ["广州塔", "长隆野生动物世界", "沙面", "陈家祠", "白云山", "永庆坊", "北京路", "广东省博物馆", "圣心大教堂",
             "珠江夜游"],
    "深圳": ["世界之窗", "欢乐港湾", "深圳湾公园", "大梅沙", "锦绣中华", "欢乐谷", "大芬油画村", "东门老街",
             "甘坑客家小镇", "仙湖植物园"],
    "成都": ["大熊猫繁育基地", "宽窄巷子", "锦里", "春熙路", "杜甫草堂", "武侯祠", "都江堰", "青城山", "太古里",
             "建设路小吃街"],
    "杭州": ["西湖", "灵隐寺", "雷峰塔", "西溪湿地", "河坊街", "宋城", "法喜寺", "龙井村", "京杭大运河", "千岛湖"],
    "西安": ["兵马俑", "大唐不夜城", "回民街", "大雁塔", "西安城墙", "陕西历史博物馆", "华清宫", "大唐芙蓉园", "钟楼",
             "小雁塔"],
    "重庆": ["洪崖洞", "解放碑", "磁器口", "李子坝轻轨", "长江索道", "朝天门", "南山一棵树", "白公馆", "渣滓洞",
             "皇冠大扶梯"],
    "武汉": ["黄鹤楼", "户部巷", "武汉大学", "东湖", "长江大桥", "江汉路", "湖北省博物馆", "楚河汉街", "古德寺",
             "昙华林"],
    "南京": ["夫子庙", "中山陵", "总统府", "南京博物院", "玄武湖", "鸡鸣寺", "秦淮河", "牛首山", "老门东", "明孝陵"],
    "长沙": ["橘子洲", "岳麓山", "五一广场", "湖南博物院", "超级文和友", "太平老街", "杜甫江阁", "谢子龙影像馆",
             "世界之窗", "马王堆汉墓"],
    "苏州": ["拙政园", "平江路", "虎丘", "寒山寺", "狮子林", "金鸡湖", "留园", "苏州博物馆", "山塘街", "周庄古镇"],
    "厦门": ["鼓浪屿", "厦门大学", "南普陀寺", "曾厝垵", "环岛路", "沙坡尾", "中山路", "植物园", "胡里山炮台",
             "集美学村"],
    "天津": ["五大道", "天津之眼", "意大利风情区", "古文化街", "瓷房子", "西开教堂", "滨海图书馆", "世纪钟", "海河游船",
             "盘山"],
    "青岛": ["栈桥", "八大关", "五四广场", "崂山", "金沙滩", "天主教堂", "极地海洋世界", "奥帆中心", "啤酒博物馆",
             "小麦岛"],
    "大理": ["大理古城", "洱海", "苍山", "双廊", "崇圣寺三塔", "喜洲古镇", "南诏风情岛", "沙溪古镇", "蝴蝶泉",
             "理想邦"],
    "丽江": ["丽江古城", "玉龙雪山", "蓝月谷", "束河古镇", "拉市海", "木府", "黑龙潭", "白沙古镇", "泸沽湖", "虎跳峡"],
    "昆明": ["滇池", "翠湖公园", "昆明老街", "石林", "云南民族村", "斗南花市", "官渡古镇", "大观楼", "金马碧鸡坊",
             "西山"],
    "哈尔滨": ["冰雪大世界", "中央大街", "圣索菲亚教堂", "太阳岛", "松花江", "老道外", "亚布力滑雪场", "防洪纪念塔",
               "龙塔", "极地馆"],
    "三亚": ["蜈支洲岛", "亚龙湾", "天涯海角", "南山文化苑", "鹿回头", "大东海", "椰梦长廊", "热带天堂森林公园", "西岛",
             "免税店"]
}


# ==========================================
# 2. 批量训练引擎
# ==========================================
def train_city_models():
    """
    按城市建立文件夹，并训练所有景点的模型
    """
    base_dir = "city_models"
    if not os.path.exists(base_dir):
        os.makedirs(base_dir)

    print(f"🚀 启动全国数据引擎，准备训练 {sum(len(v) for v in CHINA_TOUR_DB.values())} 个模型...")

    # 遍历城市
    for city, spots in CHINA_TOUR_DB.items():
        city_dir = os.path.join(base_dir, city)
        if not os.path.exists(city_dir):
            os.makedirs(city_dir)

        print(f"\n🏙️ 正在处理城市: {city}")

        for spot in spots:
            model_path = os.path.join(city_dir, f"{spot}.pkl")

            # 如果模型已存在，跳过（节省时间）
            if os.path.exists(model_path):
                print(f"  - [跳过] {spot} 模型已存在")
                continue

            print(f"  - [训练中] {spot} ...")

            # A. 数据生成 (特征工程：根据城市特性微调)
            # 模拟：北方城市冬季人少，南方冬季人多；网红城市周末效应更强
            dates = pd.date_range(end=datetime.now(), periods=24 * 60, freq='h')  # 训练过去60天数据
            data = []

            # 基础客流基数 (随机生成，大城市高一些)
            base_flow = np.random.randint(300, 1000)

            for date in dates:
                # 时间因子
                hour_factor = 1.8 if 10 <= date.hour <= 16 else 0.3
                # 周末因子
                weekend_factor = 1.6 if date.weekday() >= 5 else 1.0
                # 随机波动
                noise = np.random.normal(1, 0.15)

                flow = int(base_flow * hour_factor * weekend_factor * noise)
                data.append([date, max(0, flow)])

            df = pd.DataFrame(data, columns=['ds', 'y'])

            # B. Prophet 训练
            # 简化参数以加快训练速度
            model = Prophet(yearly_seasonality=False, weekly_seasonality=True, daily_seasonality=True)
            model.fit(df)

            # C. 保存
            joblib.dump(model, model_path)

    print("\n🎉 全国数据底座构建完成！")


if __name__ == "__main__":
    train_city_models()